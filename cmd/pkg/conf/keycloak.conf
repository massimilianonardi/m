#!/bin/sh

TYPE="github"
GITHUB_REPO="keycloak/keycloak"
GITHUB_ASSET_NAME_PATTERN="keycloak-.*.tar.gz"

FILE_TYPE="tar.gz"
SYMLINKS="keycloak=bin/kc.sh keycloak-start=bin/keycloak-start keycloak-stop=bin/keycloak-stop keycloak-status=bin/keycloak-status keycloak-install=bin/keycloak-install keycloak-uninstall=bin/keycloak-uninstall"

postinstall()
{
  #-----------------------------------------------------------------------------
  # HOME DETECTION
  #-----------------------------------------------------------------------------
  cat << EOF | tee "./bin/keycloak-install" > "./bin/keycloak-uninstall"
#!/bin/sh

if [ -L "$0" ]
then
  THIS_PATH="$(ls -ld -- "$0")"
  THIS_PATH="${THIS_PATH#*" $0 -> "}"
else
  THIS_PATH="$0"
fi

KEYCLOAK_HOME="$(cd -P -- "${THIS_PATH%/*}" && pwd -P)"

EOF



  #-----------------------------------------------------------------------------
  # INSTALL
  #-----------------------------------------------------------------------------
  cat >> "./bin/keycloak-install" << 'EOF'
sudo -s << SUDO

groupadd keycloak
useradd -r -g keycloak -d "$KEYCLOAK_HOME" -s /sbin/nologin keycloak
chown -R keycloak:keycloak "$KEYCLOAK_HOME"



cat > "/etc/systemd/system/keycloak.service" << SERVICE
[Unit]
Description=KeyCloak Service
After=network.service

[Service]
Type=simple
User=keycloak
Group=keycloak
ExecStart=$KEYCLOAK_HOME/bin/kc.sh start

[Install]
WantedBy=multi-user.target

SERVICE



chown root:root "/etc/systemd/system/keycloak.service"
chmod 644 "/etc/systemd/system/keycloak.service"
systemctl daemon-reload
systemctl enable keycloak

SUDO
EOF


  #-----------------------------------------------------------------------------
  # UNINSTALL
  #-----------------------------------------------------------------------------
  cat >> "./bin/keycloak-uninstall" << 'EOF'
sudo -s << SUDO

systemctl stop keycloak
systemctl disable keycloak
rm -f "/etc/systemd/system/keycloak.service"
systemctl daemon-reload
systemctl reset-failed

GROUP="$(groups)"
GROUP="${GROUP%% *}"
chown -R "$USER:$GROUP" "$KEYCLOAK_HOME"
userdel -r keycloak
groupdel keycloak

SUDO
EOF



  #-----------------------------------------------------------------------------
  # START
  #-----------------------------------------------------------------------------
  cat > "./bin/keycloak-start" << 'EOF'
#!/bin/sh

sudo systemctl start keycloak

EOF



  #-----------------------------------------------------------------------------
  # STOP
  #-----------------------------------------------------------------------------
  cat > "./bin/keycloak-stop" << 'EOF'
#!/bin/sh

sudo systemctl stop keycloak

EOF



  #-----------------------------------------------------------------------------
  # STATUS
  #-----------------------------------------------------------------------------
  cat > "./bin/keycloak-status" << 'EOF'
#!/bin/sh

sudo systemctl status keycloak

EOF



  chmod +x "./bin/keycloak-install"
  chmod +x "./bin/keycloak-uninstall"
  chmod +x "./bin/keycloak-start"
  chmod +x "./bin/keycloak-stop"
  chmod +x "./bin/keycloak-status"



  #-----------------------------------------------------------------------------
  # CERT
  #-----------------------------------------------------------------------------
  mkdir -p ./cert
  (
    cd ./cert
    openssl genrsa -out keycloak.key 2048
    openssl req -new -x509 -sha256 -key keycloak.key -out keycloak.crt -days 365 -subj "/C=IT/ST=Italy/L=Rome/O=X/OU=X/CN=X"
    cp keycloak.key keycloak.pem
    cat keycloak.crt >> keycloak.pem
  )



  #-----------------------------------------------------------------------------
  # CONF
  #-----------------------------------------------------------------------------
  cat > "./conf/keycloak.conf" << 'EOF'

https-certificate-file=${kc.home.dir}/cert/keycloak.crt
https-certificate-key-file=${kc.home.dir}/cert/keycloak.pem
hostname-strict=false

# db=postgres
# db-username=keycloak
# db-password=keycloak
# db-url=jdbc:postgresql://localhost:5432/keycloak

EOF



  #-----------------------------------------------------------------------------
  # DB POSTGRES
  #-----------------------------------------------------------------------------
  cat > "./bin/keycloak-postgres.sql" << 'EOF'

CREATE DATABASE keycloak;
CREATE USER keycloak WITH PASSWORD 'keycloak';
GRANT ALL PRIVILEGES ON DATABASE keycloak TO keycloak;

EOF

}
