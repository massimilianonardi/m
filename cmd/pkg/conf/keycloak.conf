#!/bin/sh

TYPE="github"
GITHUB_REPO="keycloak/keycloak"
GITHUB_ASSET_NAME_PATTERN="keycloak-.*.tar.gz"

FILE_TYPE="tar.gz"
SYMLINKS="keycloak=bin/kc.sh kcadm=bin/kcadm.sh kcreg=bin/kcreg.sh keycloak-start=keycloak-start keycloak-stop=keycloak-stop keycloak-status=keycloak-status keycloak-install=keycloak-install keycloak-uninstall=keycloak-uninstall keycloak-bootstrap-admin=keycloak-bootstrap-admin keycloak-postgres=keycloak-postgres"

postinstall()
{
  #-----------------------------------------------------------------------------
  # HOME DETECTION
  #-----------------------------------------------------------------------------
  cat << 'EOF' | tee "./keycloak-install" > "./keycloak-uninstall"
#!/bin/sh

if [ -L "$0" ]
then
  THIS_PATH="$(ls -ld -- "$0")"
  THIS_PATH="${THIS_PATH#*" $0 -> "}"
else
  THIS_PATH="$0"
fi

KEYCLOAK_HOME="$(cd -P -- "${THIS_PATH%/*}" && pwd -P)"

EOF



  #-----------------------------------------------------------------------------
  # INSTALL
  #-----------------------------------------------------------------------------
  cat << 'EOF' >> "./keycloak-install"
sudo -s << SUDO

groupadd keycloak
useradd -r -g keycloak -d "$KEYCLOAK_HOME" -s /sbin/nologin keycloak
chown -R keycloak:keycloak "$KEYCLOAK_HOME"



cat > "/etc/systemd/system/keycloak.service" << SERVICE
[Unit]
Description=KeyCloak Service
After=network.service

[Service]
Type=simple
User=keycloak
Group=keycloak
ExecStart=$KEYCLOAK_HOME/bin/kc.sh start

[Install]
WantedBy=multi-user.target

SERVICE



chown root:root "/etc/systemd/system/keycloak.service"
chmod 644 "/etc/systemd/system/keycloak.service"
systemctl daemon-reload
systemctl enable keycloak

SUDO
EOF


  #-----------------------------------------------------------------------------
  # UNINSTALL
  #-----------------------------------------------------------------------------
  cat << 'EOF' >> "./keycloak-uninstall"
sudo -s << SUDO

systemctl stop keycloak
systemctl disable keycloak
rm -f "/etc/systemd/system/keycloak.service"
systemctl daemon-reload
systemctl reset-failed

userdel -r keycloak
groupdel keycloak

GROUP="$(groups)"
GROUP="${GROUP%% *}"
chown -R "$USER:$GROUP" "$KEYCLOAK_HOME"

SUDO
EOF



  #-----------------------------------------------------------------------------
  # START
  #-----------------------------------------------------------------------------
  cat << 'EOF' > "./keycloak-start"
#!/bin/sh

sudo systemctl start keycloak

EOF



  #-----------------------------------------------------------------------------
  # STOP
  #-----------------------------------------------------------------------------
  cat << 'EOF' > "./keycloak-stop"
#!/bin/sh

sudo systemctl stop keycloak

EOF



  #-----------------------------------------------------------------------------
  # STATUS
  #-----------------------------------------------------------------------------
  cat << 'EOF' > "./keycloak-status"
#!/bin/sh

sudo systemctl status keycloak

EOF



  #-----------------------------------------------------------------------------
  # BOOTSTRAP ADMIN
  #-----------------------------------------------------------------------------
  cat << 'EOF' > "./keycloak-bootstrap-admin"
#!/bin/sh

keycloak bootstrap-admin user

EOF



  #-----------------------------------------------------------------------------
  # CERT
  #-----------------------------------------------------------------------------
  mkdir -p ./cert
  (
    cd ./cert
    openssl genrsa -out keycloak.key 2048
    openssl req -new -x509 -sha256 -key keycloak.key -out keycloak.crt -days 365 -subj "/C=IT/ST=Italy/L=Rome/O=X/OU=X/CN=X"
    cp keycloak.key keycloak.pem
    cat keycloak.crt >> keycloak.pem
  )



  #-----------------------------------------------------------------------------
  # CONF
  #-----------------------------------------------------------------------------
  cat << 'EOF' > "./conf/keycloak.conf"

# https-certificate-file=${kc.home.dir}/cert/keycloak.crt
# https-certificate-key-file=${kc.home.dir}/cert/keycloak.pem
# hostname-strict=false

https-certificate-file=/m/certs/localhost.pem
https-certificate-key-file=/m/certs/localhost.key
hostname=keycloak.local

db=postgres
db-username=keycloak
db-password=keycloak
db-url=jdbc:postgresql://localhost:5432/keycloak

EOF



  #-----------------------------------------------------------------------------
  # DB POSTGRES
  #-----------------------------------------------------------------------------
  cat << 'EOF' > "./keycloak-postgres"
#!/bin/sh

echo "WARNING!!! Press ENTER to REMOVE keycloak DB and initialize a new DB (install postgres if not present)"
read x

sudo -s << SUDO
if ! which psql > /dev/null
then
  apt update
  apt install -y postgresql
  sudo -u postgres psql -c "CREATE USER keycloak WITH PASSWORD 'keycloak';"
else
  systemctl restart postgresql
  sudo -u postgres dropdb --force --if-exists keycloak
fi

sudo -u postgres createdb keycloak
sudo -u postgres psql -d keycloak -c "ALTER DATABASE keycloak OWNER TO keycloak;"
sudo -u postgres psql -d keycloak -c "GRANT ALL PRIVILEGES ON DATABASE keycloak TO keycloak;"

SUDO
EOF



  chmod +x "./keycloak-install"
  chmod +x "./keycloak-uninstall"
  chmod +x "./keycloak-start"
  chmod +x "./keycloak-stop"
  chmod +x "./keycloak-status"
  chmod +x "./keycloak-bootstrap-admin"
  chmod +x "./keycloak-postgres"

  echo "Do you want to install service daemon? ENTER=yes, N (case insensitive)=no"
  read INSTALL_FLAG
  if [ -z "$INSTALL_FLAG" ]
  then
    "./keycloak-install"
    "./keycloak-postgres"
    nano "./conf/keycloak.conf"
    "./bin/kc.sh" bootstrap-admin user
  fi
}
