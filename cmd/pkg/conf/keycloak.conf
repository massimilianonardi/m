#!/bin/sh

TYPE="github"
GITHUB_REPO="keycloak/keycloak"
GITHUB_ASSET_NAME_PATTERN="keycloak-.*.tar.gz"

FILE_TYPE="tar.gz"
SYMLINKS="keycloak=bin/kc.sh keycloak-start=keycloak-start keycloak-stop=keycloak-stop keycloak-status=keycloak-status keycloak-install=keycloak-install keycloak-uninstall=keycloak-uninstall"

postinstall()
{
  #-----------------------------------------------------------------------------
  # HOME
  #-----------------------------------------------------------------------------
  echo "$(pwd)" > "./keycloak-home.conf"

  cat > "./keycloak-install" << EOF
#!/bin/sh

KEYCLOAK_HOME="$(pwd)"

EOF

  cat > "./keycloak-uninstall" << EOF
#!/bin/sh

KEYCLOAK_HOME="$(pwd)"

EOF



  #-----------------------------------------------------------------------------
  # INSTALL
  #-----------------------------------------------------------------------------
  cat >> "./keycloak-install" << 'EOF'
echo "Enter virtual path where service is mapped with mount bind (default: /opt/keycloak)"
read KEYCLOAK_VHOME
if [ -z "$KEYCLOAK_VHOME" ]
then
  KEYCLOAK_VHOME="/opt/keycloak"
fi

USER_UID="$(ls -ld "$KEYCLOAK_HOME" | awk '{print $3}')"
USER_GID="$(ls -ld "$KEYCLOAK_HOME" | awk '{print $4}')"
USER_UID="$(id -u "$USER_UID")"
USER_GID="$(id -g "$USER_GID")"

sudo -s << SUDO

echo "$KEYCLOAK_VHOME" > "$KEYCLOAK_HOME/keycloak-vhome.conf"
mkdir -p "$KEYCLOAK_VHOME"

groupadd keycloak
useradd -r -g keycloak -d "$KEYCLOAK_VHOME" -s /sbin/nologin keycloak
chown -R root:root "$KEYCLOAK_VHOME"
# chown -R keycloak:keycloak "$KEYCLOAK_VHOME"

KEYCLOAK_UID="\$(id -u "keycloak")"
KEYCLOAK_GID="\$(id -g "keycloak")"



cat > "/etc/systemd/system/keycloak-vhome.service" << SERVICE
[Unit]
Description=KeyCloak Virtual Home Service
After=network.service

[Service]
Type=simple
# ExecStart=mount --bind "$KEYCLOAK_HOME" "$KEYCLOAK_VHOME"
ExecStart=mount --bind -o "X-mount.idmap=u:\$KEYCLOAK_UID:$USER_UID:1 g:\$KEYCLOAK_GID:$USER_GID:1" "$KEYCLOAK_HOME" "$KEYCLOAK_VHOME"
ExecStop=umount "$KEYCLOAK_VHOME"

[Install]
WantedBy=multi-user.target

SERVICE



cat > "/etc/systemd/system/keycloak.service" << SERVICE
[Unit]
Description=KeyCloak Service
# Requires=keycloak-vhome.service
BindsTo=keycloak-vhome.service
After=network.service keycloak-vhome.service

[Service]
Type=simple
User=keycloak
Group=keycloak
ExecStart=$KEYCLOAK_VHOME/bin/kc.sh start

[Install]
WantedBy=multi-user.target

SERVICE



chown root:root "/etc/systemd/system/keycloak.service"
chmod 644 "/etc/systemd/system/keycloak.service"
systemctl daemon-reload
systemctl enable keycloak

SUDO
EOF


  #-----------------------------------------------------------------------------
  # UNINSTALL
  #-----------------------------------------------------------------------------
  cat >> "./keycloak-uninstall" << 'EOF'
sudo -s << SUDO

systemctl stop keycloak
systemctl disable keycloak
rm -f "/etc/systemd/system/keycloak.service"
systemctl stop keycloak-vhome
systemctl disable keycloak-vhome
rm -f "/etc/systemd/system/keycloak-vhome.service"
systemctl daemon-reload
systemctl reset-failed

GROUP="$(groups)"
GROUP="${GROUP%% *}"
chown -R "$USER:$GROUP" "$KEYCLOAK_HOME"
userdel -r keycloak
groupdel keycloak

SUDO
EOF



  #-----------------------------------------------------------------------------
  # START
  #-----------------------------------------------------------------------------
  cat > "./keycloak-start" << 'EOF'
#!/bin/sh

sudo systemctl start keycloak

EOF



  #-----------------------------------------------------------------------------
  # STOP
  #-----------------------------------------------------------------------------
  cat > "./keycloak-stop" << 'EOF'
#!/bin/sh

sudo systemctl stop keycloak

EOF



  #-----------------------------------------------------------------------------
  # STATUS
  #-----------------------------------------------------------------------------
  cat > "./keycloak-status" << 'EOF'
#!/bin/sh

sudo systemctl status keycloak

EOF



  chmod +x "./keycloak-install"
  chmod +x "./keycloak-uninstall"
  chmod +x "./keycloak-start"
  chmod +x "./keycloak-stop"
  chmod +x "./keycloak-status"
}
