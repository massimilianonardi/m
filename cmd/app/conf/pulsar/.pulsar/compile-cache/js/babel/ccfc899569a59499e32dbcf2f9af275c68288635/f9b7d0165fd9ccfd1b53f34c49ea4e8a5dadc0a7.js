"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _path = _interopRequireDefault(require("path"));
var _underscorePlus = _interopRequireDefault(require("underscore-plus"));
var _atom = require("atom");
var _etch = _interopRequireDefault(require("etch"));
var _keybindingsPanel = _interopRequireDefault(require("./keybindings-panel"));
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
/** @babel */
/** @jsx etch.dom */

// Displays the keybindings for a package namespace
class PackageKeymapView {
  constructor(pack) {
    this.pack = pack;
    this.namespace = this.pack.name;
    this.disposables = new _atom.CompositeDisposable();
    _etch.default.initialize(this);
    const packagesWithKeymapsDisabled = atom.config.get('core.packagesWithKeymapsDisabled') || [];
    this.refs.keybindingToggle.checked = !packagesWithKeymapsDisabled.includes(this.namespace);
    const changeHandler = event => {
      event.stopPropagation();
      const value = this.refs.keybindingToggle.checked;
      if (value) {
        atom.config.removeAtKeyPath('core.packagesWithKeymapsDisabled', this.namespace);
      } else {
        atom.config.pushAtKeyPath('core.packagesWithKeymapsDisabled', this.namespace);
      }
      this.updateKeyBindingView();
    };
    this.refs.keybindingToggle.addEventListener('change', changeHandler);
    this.disposables.add(new _atom.Disposable(() => {
      this.refs.keybindingToggle.removeEventListener('change', changeHandler);
    }));
    const copyIconClickHandler = event => {
      const target = event.target.closest('.copy-icon');
      if (target) {
        event.preventDefault();
        event.stopPropagation();
        this.writeKeyBindingToClipboard(target.closest('tr').dataset);
      }
    };
    this.element.addEventListener('click', copyIconClickHandler);
    this.disposables.add(new _atom.Disposable(() => {
      this.element.removeEventListener('click', copyIconClickHandler);
    }));
    this.updateKeyBindingView();
    let hasKeymaps = false;
    // eslint-disable-next-line no-unused-vars
    for (let [packageKeymapsPath, keymap] of atom.packages.getLoadedPackage(this.namespace).keymaps) {
      if (keymap.length > 0) {
        hasKeymaps = true;
        break;
      }
    }
    if (this.refs.keybindingItems.children.length === 0 && !hasKeymaps) {
      this.element.style.display = 'none';
    }
  }
  update() {}
  destroy() {
    this.disposables.dispose();
    return _etch.default.destroy(this);
  }
  render() {
    return _etch.default.dom("section", {
      className: "section"
    }, _etch.default.dom("div", {
      className: "section-heading icon icon-keyboard"
    }, "Keybindings"), _etch.default.dom("div", {
      className: "checkbox"
    }, _etch.default.dom("label", {
      for: "toggleKeybindings"
    }, _etch.default.dom("input", {
      id: "toggleKeybindings",
      className: "input-checkbox",
      type: "checkbox",
      ref: "keybindingToggle"
    }), _etch.default.dom("div", {
      className: "setting-title"
    }, "Enable")), _etch.default.dom("div", {
      className: "setting-description"
    }, "Disable this if you want to bind your own keystrokes for this package's commands in your keymap.")), _etch.default.dom("table", {
      className: "package-keymap-table table native-key-bindings text",
      tabIndex: "-1"
    }, _etch.default.dom("thead", null, _etch.default.dom("tr", null, _etch.default.dom("th", null, "Keystroke"), _etch.default.dom("th", null, "Command"), _etch.default.dom("th", null, "Selector"), _etch.default.dom("th", null, "Source"))), _etch.default.dom("tbody", {
      ref: "keybindingItems"
    })));
  }
  updateKeyBindingView() {
    this.refs.keybindingItems.innerHTML = '';
    const packagesWithKeymapsDisabled = atom.config.get('core.packagesWithKeymapsDisabled') || [];
    const keybindingsDisabled = packagesWithKeymapsDisabled.includes(this.namespace);
    if (keybindingsDisabled) {
      this.refs.keybindingItems.classList.add('text-subtle');
    } else {
      this.refs.keybindingItems.classList.remove('text-subtle');
    }
    const keyBindings = [];
    if (atom.keymaps.build) {
      // eslint-disable-next-line no-unused-vars
      for (const [keymapPath, keymap] of atom.packages.getLoadedPackage(this.namespace).keymaps) {
        keyBindings.push(...atom.keymaps.build(this.namespace, keymap, 0, false));
      }
    } else {
      // Backwards compatibility for Atom <= 1.19
      for (const keyBinding of atom.keymaps.getKeyBindings()) {
        const {
          command
        } = keyBinding;
        if (command && command.indexOf && command.indexOf(`${this.namespace}:`) === 0) {
          keyBindings.push(keyBinding);
        }
      }
    }
    for (const keyBinding of keyBindings) {
      const {
        command,
        keystrokes,
        selector,
        source
      } = keyBinding;
      if (!command) {
        continue;
      }
      if (!this.selectorIsCompatibleWithPlatform(selector)) {
        continue;
      }
      const keyBindingRow = document.createElement('tr');
      keyBindingRow.dataset.selector = selector;
      keyBindingRow.dataset.keystrokes = keystrokes;
      keyBindingRow.dataset.command = command;
      const keystrokesTd = document.createElement('td');
      const copyIconSpan = document.createElement('span');
      copyIconSpan.classList.add('icon', 'icon-clippy', 'copy-icon');
      keystrokesTd.appendChild(copyIconSpan);
      const keystrokesSpan = document.createElement('span');
      keystrokesSpan.textContent = keystrokes;
      keystrokesTd.appendChild(keystrokesSpan);
      keyBindingRow.appendChild(keystrokesTd);
      const commandTd = document.createElement('td');
      commandTd.textContent = command;
      keyBindingRow.appendChild(commandTd);
      const selectorTd = document.createElement('td');
      selectorTd.textContent = selector;
      keyBindingRow.appendChild(selectorTd);
      const sourceTd = document.createElement('td');
      sourceTd.textContent = _keybindingsPanel.default.determineSource(source);
      keyBindingRow.appendChild(sourceTd);
      this.refs.keybindingItems.appendChild(keyBindingRow);
    }
  }
  writeKeyBindingToClipboard({
    selector,
    keystrokes,
    command
  }) {
    let content;
    const keymapExtension = _path.default.extname(atom.keymaps.getUserKeymapPath());
    if (keymapExtension === '.cson') {
      content = `\
'${selector}':
  '${keystrokes}': '${command}'\
`;
    } else {
      content = `\
"${selector}": {
  "${keystrokes}": "${command}"
}\
`;
    }
    atom.clipboard.write(content);
  }
  selectorIsCompatibleWithPlatform(selector, platform = process.platform) {
    const otherPlatformPattern = new RegExp(`\\.platform-(?!${_underscorePlus.default.escapeRegExp(platform)}\\b)`);
    const currentPlatformPattern = new RegExp(`\\.platform-(${_underscorePlus.default.escapeRegExp(platform)}\\b)`);
    return !(otherPlatformPattern.test(selector) && !currentPlatformPattern.test(selector));
  }
}
exports.default = PackageKeymapView;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJQYWNrYWdlS2V5bWFwVmlldyIsImNvbnN0cnVjdG9yIiwicGFjayIsIm5hbWVzcGFjZSIsIm5hbWUiLCJkaXNwb3NhYmxlcyIsIkNvbXBvc2l0ZURpc3Bvc2FibGUiLCJldGNoIiwiaW5pdGlhbGl6ZSIsInBhY2thZ2VzV2l0aEtleW1hcHNEaXNhYmxlZCIsImF0b20iLCJjb25maWciLCJnZXQiLCJyZWZzIiwia2V5YmluZGluZ1RvZ2dsZSIsImNoZWNrZWQiLCJpbmNsdWRlcyIsImNoYW5nZUhhbmRsZXIiLCJldmVudCIsInN0b3BQcm9wYWdhdGlvbiIsInZhbHVlIiwicmVtb3ZlQXRLZXlQYXRoIiwicHVzaEF0S2V5UGF0aCIsInVwZGF0ZUtleUJpbmRpbmdWaWV3IiwiYWRkRXZlbnRMaXN0ZW5lciIsImFkZCIsIkRpc3Bvc2FibGUiLCJyZW1vdmVFdmVudExpc3RlbmVyIiwiY29weUljb25DbGlja0hhbmRsZXIiLCJ0YXJnZXQiLCJjbG9zZXN0IiwicHJldmVudERlZmF1bHQiLCJ3cml0ZUtleUJpbmRpbmdUb0NsaXBib2FyZCIsImRhdGFzZXQiLCJlbGVtZW50IiwiaGFzS2V5bWFwcyIsInBhY2thZ2VLZXltYXBzUGF0aCIsImtleW1hcCIsInBhY2thZ2VzIiwiZ2V0TG9hZGVkUGFja2FnZSIsImtleW1hcHMiLCJsZW5ndGgiLCJrZXliaW5kaW5nSXRlbXMiLCJjaGlsZHJlbiIsInN0eWxlIiwiZGlzcGxheSIsInVwZGF0ZSIsImRlc3Ryb3kiLCJkaXNwb3NlIiwicmVuZGVyIiwiaW5uZXJIVE1MIiwia2V5YmluZGluZ3NEaXNhYmxlZCIsImNsYXNzTGlzdCIsInJlbW92ZSIsImtleUJpbmRpbmdzIiwiYnVpbGQiLCJrZXltYXBQYXRoIiwicHVzaCIsImtleUJpbmRpbmciLCJnZXRLZXlCaW5kaW5ncyIsImNvbW1hbmQiLCJpbmRleE9mIiwia2V5c3Ryb2tlcyIsInNlbGVjdG9yIiwic291cmNlIiwic2VsZWN0b3JJc0NvbXBhdGlibGVXaXRoUGxhdGZvcm0iLCJrZXlCaW5kaW5nUm93IiwiZG9jdW1lbnQiLCJjcmVhdGVFbGVtZW50Iiwia2V5c3Ryb2tlc1RkIiwiY29weUljb25TcGFuIiwiYXBwZW5kQ2hpbGQiLCJrZXlzdHJva2VzU3BhbiIsInRleHRDb250ZW50IiwiY29tbWFuZFRkIiwic2VsZWN0b3JUZCIsInNvdXJjZVRkIiwiS2V5YmluZGluZ3NQYW5lbCIsImRldGVybWluZVNvdXJjZSIsImNvbnRlbnQiLCJrZXltYXBFeHRlbnNpb24iLCJwYXRoIiwiZXh0bmFtZSIsImdldFVzZXJLZXltYXBQYXRoIiwiY2xpcGJvYXJkIiwid3JpdGUiLCJwbGF0Zm9ybSIsInByb2Nlc3MiLCJvdGhlclBsYXRmb3JtUGF0dGVybiIsIlJlZ0V4cCIsIl8iLCJlc2NhcGVSZWdFeHAiLCJjdXJyZW50UGxhdGZvcm1QYXR0ZXJuIiwidGVzdCJdLCJzb3VyY2VzIjpbInBhY2thZ2Uta2V5bWFwLXZpZXcuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqIEBiYWJlbCAqL1xuLyoqIEBqc3ggZXRjaC5kb20gKi9cblxuaW1wb3J0IHBhdGggZnJvbSAncGF0aCdcbmltcG9ydCBfIGZyb20gJ3VuZGVyc2NvcmUtcGx1cydcbmltcG9ydCB7RGlzcG9zYWJsZSwgQ29tcG9zaXRlRGlzcG9zYWJsZX0gZnJvbSAnYXRvbSdcbmltcG9ydCBldGNoIGZyb20gJ2V0Y2gnXG5pbXBvcnQgS2V5YmluZGluZ3NQYW5lbCBmcm9tICcuL2tleWJpbmRpbmdzLXBhbmVsJ1xuXG4vLyBEaXNwbGF5cyB0aGUga2V5YmluZGluZ3MgZm9yIGEgcGFja2FnZSBuYW1lc3BhY2VcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFBhY2thZ2VLZXltYXBWaWV3IHtcbiAgY29uc3RydWN0b3IgKHBhY2spIHtcbiAgICB0aGlzLnBhY2sgPSBwYWNrXG4gICAgdGhpcy5uYW1lc3BhY2UgPSB0aGlzLnBhY2submFtZVxuICAgIHRoaXMuZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gICAgZXRjaC5pbml0aWFsaXplKHRoaXMpXG5cbiAgICBjb25zdCBwYWNrYWdlc1dpdGhLZXltYXBzRGlzYWJsZWQgPSBhdG9tLmNvbmZpZy5nZXQoJ2NvcmUucGFja2FnZXNXaXRoS2V5bWFwc0Rpc2FibGVkJykgfHwgW11cbiAgICB0aGlzLnJlZnMua2V5YmluZGluZ1RvZ2dsZS5jaGVja2VkID0gIXBhY2thZ2VzV2l0aEtleW1hcHNEaXNhYmxlZC5pbmNsdWRlcyh0aGlzLm5hbWVzcGFjZSlcblxuICAgIGNvbnN0IGNoYW5nZUhhbmRsZXIgPSAoZXZlbnQpID0+IHtcbiAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpXG4gICAgICBjb25zdCB2YWx1ZSA9IHRoaXMucmVmcy5rZXliaW5kaW5nVG9nZ2xlLmNoZWNrZWRcbiAgICAgIGlmICh2YWx1ZSkge1xuICAgICAgICBhdG9tLmNvbmZpZy5yZW1vdmVBdEtleVBhdGgoJ2NvcmUucGFja2FnZXNXaXRoS2V5bWFwc0Rpc2FibGVkJywgdGhpcy5uYW1lc3BhY2UpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhdG9tLmNvbmZpZy5wdXNoQXRLZXlQYXRoKCdjb3JlLnBhY2thZ2VzV2l0aEtleW1hcHNEaXNhYmxlZCcsIHRoaXMubmFtZXNwYWNlKVxuICAgICAgfVxuXG4gICAgICB0aGlzLnVwZGF0ZUtleUJpbmRpbmdWaWV3KClcbiAgICB9XG4gICAgdGhpcy5yZWZzLmtleWJpbmRpbmdUb2dnbGUuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgY2hhbmdlSGFuZGxlcilcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChuZXcgRGlzcG9zYWJsZSgoKSA9PiB7IHRoaXMucmVmcy5rZXliaW5kaW5nVG9nZ2xlLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIGNoYW5nZUhhbmRsZXIpIH0pKVxuXG4gICAgY29uc3QgY29weUljb25DbGlja0hhbmRsZXIgPSAoZXZlbnQpID0+IHtcbiAgICAgIGNvbnN0IHRhcmdldCA9IGV2ZW50LnRhcmdldC5jbG9zZXN0KCcuY29weS1pY29uJylcbiAgICAgIGlmICh0YXJnZXQpIHtcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKVxuICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKVxuICAgICAgICB0aGlzLndyaXRlS2V5QmluZGluZ1RvQ2xpcGJvYXJkKHRhcmdldC5jbG9zZXN0KCd0cicpLmRhdGFzZXQpXG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGNvcHlJY29uQ2xpY2tIYW5kbGVyKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKG5ldyBEaXNwb3NhYmxlKCgpID0+IHsgdGhpcy5lbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgY29weUljb25DbGlja0hhbmRsZXIpIH0pKVxuXG4gICAgdGhpcy51cGRhdGVLZXlCaW5kaW5nVmlldygpXG5cbiAgICBsZXQgaGFzS2V5bWFwcyA9IGZhbHNlXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVudXNlZC12YXJzXG4gICAgZm9yIChsZXQgW3BhY2thZ2VLZXltYXBzUGF0aCwga2V5bWFwXSBvZiBhdG9tLnBhY2thZ2VzLmdldExvYWRlZFBhY2thZ2UodGhpcy5uYW1lc3BhY2UpLmtleW1hcHMpIHtcbiAgICAgIGlmIChrZXltYXAubGVuZ3RoID4gMCkge1xuICAgICAgICBoYXNLZXltYXBzID0gdHJ1ZVxuICAgICAgICBicmVha1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICh0aGlzLnJlZnMua2V5YmluZGluZ0l0ZW1zLmNoaWxkcmVuLmxlbmd0aCA9PT0gMCAmJiAhaGFzS2V5bWFwcykge1xuICAgICAgdGhpcy5lbGVtZW50LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSdcbiAgICB9XG4gIH1cblxuICB1cGRhdGUgKCkge31cblxuICBkZXN0cm95ICgpIHtcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmRpc3Bvc2UoKVxuICAgIHJldHVybiBldGNoLmRlc3Ryb3kodGhpcylcbiAgfVxuXG4gIHJlbmRlciAoKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIDxzZWN0aW9uIGNsYXNzTmFtZT0nc2VjdGlvbic+XG4gICAgICAgIDxkaXYgY2xhc3NOYW1lPSdzZWN0aW9uLWhlYWRpbmcgaWNvbiBpY29uLWtleWJvYXJkJz5LZXliaW5kaW5nczwvZGl2PlxuICAgICAgICA8ZGl2IGNsYXNzTmFtZT0nY2hlY2tib3gnPlxuICAgICAgICAgIDxsYWJlbCBmb3I9J3RvZ2dsZUtleWJpbmRpbmdzJz5cbiAgICAgICAgICAgIDxpbnB1dCBpZD0ndG9nZ2xlS2V5YmluZGluZ3MnIGNsYXNzTmFtZT0naW5wdXQtY2hlY2tib3gnIHR5cGU9J2NoZWNrYm94JyByZWY9J2tleWJpbmRpbmdUb2dnbGUnIC8+XG4gICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0nc2V0dGluZy10aXRsZSc+RW5hYmxlPC9kaXY+XG4gICAgICAgICAgPC9sYWJlbD5cbiAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0nc2V0dGluZy1kZXNjcmlwdGlvbic+XG4gICAgICAgICAgICB7XCJEaXNhYmxlIHRoaXMgaWYgeW91IHdhbnQgdG8gYmluZCB5b3VyIG93biBrZXlzdHJva2VzIGZvciB0aGlzIHBhY2thZ2UncyBjb21tYW5kcyBpbiB5b3VyIGtleW1hcC5cIn1cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgPC9kaXY+XG4gICAgICAgIDx0YWJsZSBjbGFzc05hbWU9J3BhY2thZ2Uta2V5bWFwLXRhYmxlIHRhYmxlIG5hdGl2ZS1rZXktYmluZGluZ3MgdGV4dCcgdGFiSW5kZXg9Jy0xJz5cbiAgICAgICAgICA8dGhlYWQ+XG4gICAgICAgICAgICA8dHI+XG4gICAgICAgICAgICAgIDx0aD5LZXlzdHJva2U8L3RoPlxuICAgICAgICAgICAgICA8dGg+Q29tbWFuZDwvdGg+XG4gICAgICAgICAgICAgIDx0aD5TZWxlY3RvcjwvdGg+XG4gICAgICAgICAgICAgIDx0aD5Tb3VyY2U8L3RoPlxuICAgICAgICAgICAgPC90cj5cbiAgICAgICAgICA8L3RoZWFkPlxuICAgICAgICAgIDx0Ym9keSByZWY9J2tleWJpbmRpbmdJdGVtcycgLz5cbiAgICAgICAgPC90YWJsZT5cbiAgICAgIDwvc2VjdGlvbj5cbiAgICApXG4gIH1cblxuICB1cGRhdGVLZXlCaW5kaW5nVmlldyAoKSB7XG4gICAgdGhpcy5yZWZzLmtleWJpbmRpbmdJdGVtcy5pbm5lckhUTUwgPSAnJ1xuXG4gICAgY29uc3QgcGFja2FnZXNXaXRoS2V5bWFwc0Rpc2FibGVkID0gYXRvbS5jb25maWcuZ2V0KCdjb3JlLnBhY2thZ2VzV2l0aEtleW1hcHNEaXNhYmxlZCcpIHx8IFtdXG4gICAgY29uc3Qga2V5YmluZGluZ3NEaXNhYmxlZCA9IHBhY2thZ2VzV2l0aEtleW1hcHNEaXNhYmxlZC5pbmNsdWRlcyh0aGlzLm5hbWVzcGFjZSlcbiAgICBpZiAoa2V5YmluZGluZ3NEaXNhYmxlZCkge1xuICAgICAgdGhpcy5yZWZzLmtleWJpbmRpbmdJdGVtcy5jbGFzc0xpc3QuYWRkKCd0ZXh0LXN1YnRsZScpXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucmVmcy5rZXliaW5kaW5nSXRlbXMuY2xhc3NMaXN0LnJlbW92ZSgndGV4dC1zdWJ0bGUnKVxuICAgIH1cblxuICAgIGNvbnN0IGtleUJpbmRpbmdzID0gW11cbiAgICBpZiAoYXRvbS5rZXltYXBzLmJ1aWxkKSB7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdW51c2VkLXZhcnNcbiAgICAgIGZvciAoY29uc3QgW2tleW1hcFBhdGgsIGtleW1hcF0gb2YgYXRvbS5wYWNrYWdlcy5nZXRMb2FkZWRQYWNrYWdlKHRoaXMubmFtZXNwYWNlKS5rZXltYXBzKSB7XG4gICAgICAgIGtleUJpbmRpbmdzLnB1c2goLi4uYXRvbS5rZXltYXBzLmJ1aWxkKHRoaXMubmFtZXNwYWNlLCBrZXltYXAsIDAsIGZhbHNlKSlcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgLy8gQmFja3dhcmRzIGNvbXBhdGliaWxpdHkgZm9yIEF0b20gPD0gMS4xOVxuICAgICAgZm9yIChjb25zdCBrZXlCaW5kaW5nIG9mIGF0b20ua2V5bWFwcy5nZXRLZXlCaW5kaW5ncygpKSB7XG4gICAgICAgIGNvbnN0IHtjb21tYW5kfSA9IGtleUJpbmRpbmdcbiAgICAgICAgaWYgKGNvbW1hbmQgJiYgY29tbWFuZC5pbmRleE9mICYmIGNvbW1hbmQuaW5kZXhPZihgJHt0aGlzLm5hbWVzcGFjZX06YCkgPT09IDApIHtcbiAgICAgICAgICBrZXlCaW5kaW5ncy5wdXNoKGtleUJpbmRpbmcpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IGtleUJpbmRpbmcgb2Yga2V5QmluZGluZ3MpIHtcbiAgICAgIGNvbnN0IHtjb21tYW5kLCBrZXlzdHJva2VzLCBzZWxlY3Rvciwgc291cmNlfSA9IGtleUJpbmRpbmdcbiAgICAgIGlmICghY29tbWFuZCkge1xuICAgICAgICBjb250aW51ZVxuICAgICAgfVxuXG4gICAgICBpZiAoIXRoaXMuc2VsZWN0b3JJc0NvbXBhdGlibGVXaXRoUGxhdGZvcm0oc2VsZWN0b3IpKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBrZXlCaW5kaW5nUm93ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndHInKVxuICAgICAga2V5QmluZGluZ1Jvdy5kYXRhc2V0LnNlbGVjdG9yID0gc2VsZWN0b3JcbiAgICAgIGtleUJpbmRpbmdSb3cuZGF0YXNldC5rZXlzdHJva2VzID0ga2V5c3Ryb2tlc1xuICAgICAga2V5QmluZGluZ1Jvdy5kYXRhc2V0LmNvbW1hbmQgPSBjb21tYW5kXG5cbiAgICAgIGNvbnN0IGtleXN0cm9rZXNUZCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RkJylcblxuICAgICAgY29uc3QgY29weUljb25TcGFuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpXG4gICAgICBjb3B5SWNvblNwYW4uY2xhc3NMaXN0LmFkZCgnaWNvbicsICdpY29uLWNsaXBweScsICdjb3B5LWljb24nKVxuICAgICAga2V5c3Ryb2tlc1RkLmFwcGVuZENoaWxkKGNvcHlJY29uU3BhbilcblxuICAgICAgY29uc3Qga2V5c3Ryb2tlc1NwYW4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJylcbiAgICAgIGtleXN0cm9rZXNTcGFuLnRleHRDb250ZW50ID0ga2V5c3Ryb2tlc1xuICAgICAga2V5c3Ryb2tlc1RkLmFwcGVuZENoaWxkKGtleXN0cm9rZXNTcGFuKVxuXG4gICAgICBrZXlCaW5kaW5nUm93LmFwcGVuZENoaWxkKGtleXN0cm9rZXNUZClcblxuICAgICAgY29uc3QgY29tbWFuZFRkID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGQnKVxuICAgICAgY29tbWFuZFRkLnRleHRDb250ZW50ID0gY29tbWFuZFxuICAgICAga2V5QmluZGluZ1Jvdy5hcHBlbmRDaGlsZChjb21tYW5kVGQpXG5cbiAgICAgIGNvbnN0IHNlbGVjdG9yVGQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0ZCcpXG4gICAgICBzZWxlY3RvclRkLnRleHRDb250ZW50ID0gc2VsZWN0b3JcbiAgICAgIGtleUJpbmRpbmdSb3cuYXBwZW5kQ2hpbGQoc2VsZWN0b3JUZClcblxuICAgICAgY29uc3Qgc291cmNlVGQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0ZCcpXG4gICAgICBzb3VyY2VUZC50ZXh0Q29udGVudCA9IEtleWJpbmRpbmdzUGFuZWwuZGV0ZXJtaW5lU291cmNlKHNvdXJjZSlcbiAgICAgIGtleUJpbmRpbmdSb3cuYXBwZW5kQ2hpbGQoc291cmNlVGQpXG5cbiAgICAgIHRoaXMucmVmcy5rZXliaW5kaW5nSXRlbXMuYXBwZW5kQ2hpbGQoa2V5QmluZGluZ1JvdylcbiAgICB9XG4gIH1cblxuICB3cml0ZUtleUJpbmRpbmdUb0NsaXBib2FyZCAoe3NlbGVjdG9yLCBrZXlzdHJva2VzLCBjb21tYW5kfSkge1xuICAgIGxldCBjb250ZW50XG4gICAgY29uc3Qga2V5bWFwRXh0ZW5zaW9uID0gcGF0aC5leHRuYW1lKGF0b20ua2V5bWFwcy5nZXRVc2VyS2V5bWFwUGF0aCgpKVxuICAgIGlmIChrZXltYXBFeHRlbnNpb24gPT09ICcuY3NvbicpIHtcbiAgICAgIGNvbnRlbnQgPSBgXFxcbicke3NlbGVjdG9yfSc6XG4gICcke2tleXN0cm9rZXN9JzogJyR7Y29tbWFuZH0nXFxcbmBcbiAgICB9IGVsc2Uge1xuICAgICAgY29udGVudCA9IGBcXFxuXCIke3NlbGVjdG9yfVwiOiB7XG4gIFwiJHtrZXlzdHJva2VzfVwiOiBcIiR7Y29tbWFuZH1cIlxufVxcXG5gXG4gICAgfVxuXG4gICAgYXRvbS5jbGlwYm9hcmQud3JpdGUoY29udGVudClcbiAgfVxuXG4gIHNlbGVjdG9ySXNDb21wYXRpYmxlV2l0aFBsYXRmb3JtKHNlbGVjdG9yLCBwbGF0Zm9ybSA9IHByb2Nlc3MucGxhdGZvcm0pIHtcbiAgICBjb25zdCBvdGhlclBsYXRmb3JtUGF0dGVybiA9IG5ldyBSZWdFeHAoYFxcXFwucGxhdGZvcm0tKD8hJHtfLmVzY2FwZVJlZ0V4cChwbGF0Zm9ybSl9XFxcXGIpYCk7XG4gICAgY29uc3QgY3VycmVudFBsYXRmb3JtUGF0dGVybiA9IG5ldyBSZWdFeHAoYFxcXFwucGxhdGZvcm0tKCR7Xy5lc2NhcGVSZWdFeHAocGxhdGZvcm0pfVxcXFxiKWApO1xuXG4gICAgcmV0dXJuICEob3RoZXJQbGF0Zm9ybVBhdHRlcm4udGVzdChzZWxlY3RvcikgJiYgIWN1cnJlbnRQbGF0Zm9ybVBhdHRlcm4udGVzdChzZWxlY3RvcikpO1xuICB9XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7OztBQUdBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFBa0Q7QUFQbEQ7QUFDQTs7QUFRQTtBQUNlLE1BQU1BLGlCQUFpQixDQUFDO0VBQ3JDQyxXQUFXLENBQUVDLElBQUksRUFBRTtJQUNqQixJQUFJLENBQUNBLElBQUksR0FBR0EsSUFBSTtJQUNoQixJ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