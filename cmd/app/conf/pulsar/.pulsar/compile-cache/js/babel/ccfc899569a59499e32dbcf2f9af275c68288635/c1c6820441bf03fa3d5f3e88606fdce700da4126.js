"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _fs = _interopRequireDefault(require("fs"));
var _humanizePlus = _interopRequireDefault(require("humanize-plus"));
var _lsArchive = _interopRequireDefault(require("ls-archive"));
var _atom = require("atom");
var _etch = _interopRequireDefault(require("etch"));
var _fileView = _interopRequireDefault(require("./file-view"));
var _directoryView = _interopRequireDefault(require("./directory-view"));
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
/** @babel */
/** @jsx etch.dom */

class ArchiveEditorView {
  constructor(archivePath) {
    this.disposables = new _atom.CompositeDisposable();
    this.emitter = new _atom.Emitter();
    this.path = archivePath;
    this.file = new _atom.File(this.path);
    this.entries = [];
    _etch.default.initialize(this);
    this.refresh();
    this.disposables.add(this.file.onDidChange(() => this.refresh()));
    this.disposables.add(this.file.onDidRename(() => this.refresh()));
    this.disposables.add(this.file.onDidDelete(() => this.destroy()));
    const focusHandler = () => this.focusSelectedFile();
    this.element.addEventListener('focus', focusHandler);
    this.disposables.add(new _atom.Disposable(() => this.element.removeEventListener('focus', focusHandler)));
  }
  update() {}
  render() {
    return _etch.default.dom("div", {
      className: "archive-editor",
      tabIndex: "-1"
    }, _etch.default.dom("div", {
      className: "archive-container"
    }, _etch.default.dom("div", {
      ref: "loadingMessage",
      className: "padded icon icon-hourglass text-info"
    }, `Loading archive\u2026`), _etch.default.dom("div", {
      ref: "errorMessage",
      className: "padded icon icon-alert text-error"
    }), _etch.default.dom("div", {
      className: "inset-panel"
    }, _etch.default.dom("div", {
      ref: "summary",
      className: "panel-heading"
    }), _etch.default.dom("ol", {
      ref: "tree",
      className: "archive-tree padded list-tree has-collapsable-children"
    }))));
  }
  copy() {
    return new ArchiveEditorView(this.path);
  }
  destroy() {
    while (this.entries.length > 0) {
      this.entries.pop().destroy();
    }
    this.disposables.dispose();
    this.emitter.emit('did-destroy');
    _etch.default.destroy(this);
  }
  onDidDestroy(callback) {
    return this.emitter.on('did-destroy', callback);
  }
  onDidChangeTitle(callback) {
    return this.emitter.on('did-change-title', callback);
  }
  serialize() {
    return {
      deserializer: this.constructor.name,
      path: this.path
    };
  }
  getPath() {
    return this.file.getPath();
  }
  getTitle() {
    return this.path ? this.file.getBaseName() : 'untitled';
  }
  getURI() {
    return this.path;
  }
  refresh() {
    this.refs.summary.style.display = 'none';
    this.refs.tree.style.display = 'none';
    this.refs.loadingMessage.style.display = '';
    this.refs.errorMessage.style.display = 'none';
    if (this.path !== this.getPath()) {
      this.path = this.getPath();
      this.emitter.emit('did-change-title');
    }
    const originalPath = this.path;
    _lsArchive.default.list(this.path, {
      tree: true
    }, (error, entries) => {
      if (originalPath !== this.path) {
        return;
      }
      if (error != null) {
        let message = 'Reading the archive file failed';
        if (error.message) {
          message += `: ${error.message}`;
        }
        this.refs.errorMessage.style.display = '';
        this.refs.errorMessage.textContent = message;
      } else {
        this.createTreeEntries(entries);
        this.updateSummary();
      }

      // We hide the loading message _after_ creating the archive tree
      // to avoid forced reflows.
      this.refs.loadingMessage.style.display = 'none';
    });
  }
  createTreeEntries(entries) {
    while (this.entries.length > 0) {
      this.entries.pop().destroy();
    }
    let index = 0;
    for (const entry of entries) {
      if (entry.isDirectory()) {
        const entryView = new _directoryView.default(this, index, this.path, entry);
        this.entries.push(entryView);
      } else {
        const entryView = new _fileView.default(this, index, this.path, entry);
        this.entries.push(entryView);
      }
      index++;
    }
    this.selectFileAfterIndex(-1);

    // Wait until selecting (focusing) the first file before appending the entries
    // to avoid a double-forced reflow when focusing.
    for (const entry of this.entries) {
      this.refs.tree.appendChild(entry.element);
    }
    this.refs.tree.style.display = '';
  }
  updateSummary() {
    const fileCount = this.entries.filter(entry => entry instanceof _fileView.default).length;
    const fileLabel = fileCount === 1 ? '1 file' : `${_humanizePlus.default.intComma(fileCount)} files`;
    const directoryCount = this.entries.filter(entry => entry instanceof _directoryView.default).length;
    const directoryLabel = directoryCount === 1 ? '1 folder' : `${_humanizePlus.default.intComma(directoryCount)} folders`;
    this.refs.summary.style.display = '';
    let fileSize;
    try {
      var _fs$statSync;
      fileSize = (_fs$statSync = _fs.default.statSync(this.path)) === null || _fs$statSync === void 0 ? void 0 : _fs$statSync.size;
    } catch (e) {}
    if (fileSize == null) fileSize = -1;
    this.refs.summary.textContent = `${_humanizePlus.default.fileSize(fileSize)} with ${fileLabel} and ${directoryLabel}`;
  }
  focusSelectedFile() {
    const selectedFile = this.refs.tree.querySelector('.selected');
    if (selectedFile) {
      selectedFile.focus();
    }
  }
  selectFileBeforeIndex(index) {
    for (let i = index - 1; i >= 0; i--) {
      const previousEntry = this.entries[i];
      if (previousEntry instanceof _fileView.default) {
        previousEntry.select();
        break;
      } else {
        if (previousEntry.selectLastFile()) {
          break;
        }
      }
    }
  }
  selectFileAfterIndex(index) {
    for (let i = index + 1; i < this.entries.length; i++) {
      const nextEntry = this.entries[i];
      if (nextEntry instanceof _fileView.default) {
        nextEntry.select();
        break;
      } else {
        if (nextEntry.selectFirstFile()) {
          break;
        }
      }
    }
  }
  focus() {
    this.focusSelectedFile();
  }
}
exports.default = ArchiveEditorView;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJBcmNoaXZlRWRpdG9yVmlldyIsImNvbnN0cnVjdG9yIiwiYXJjaGl2ZVBhdGgiLCJkaXNwb3NhYmxlcyIsIkNvbXBvc2l0ZURpc3Bvc2FibGUiLCJlbWl0dGVyIiwiRW1pdHRlciIsInBhdGgiLCJmaWxlIiwiRmlsZSIsImVudHJpZXMiLCJldGNoIiwiaW5pdGlhbGl6ZSIsInJlZnJlc2giLCJhZGQiLCJvbkRpZENoYW5nZSIsIm9uRGlkUmVuYW1lIiwib25EaWREZWxldGUiLCJkZXN0cm95IiwiZm9jdXNIYW5kbGVyIiwiZm9jdXNTZWxlY3RlZEZpbGUiLCJlbGVtZW50IiwiYWRkRXZlbnRMaXN0ZW5lciIsIkRpc3Bvc2FibGUiLCJyZW1vdmVFdmVudExpc3RlbmVyIiwidXBkYXRlIiwicmVuZGVyIiwiY29weSIsImxlbmd0aCIsInBvcCIsImRpc3Bvc2UiLCJlbWl0Iiwib25EaWREZXN0cm95IiwiY2FsbGJhY2siLCJvbiIsIm9uRGlkQ2hhbmdlVGl0bGUiLCJzZXJpYWxpemUiLCJkZXNlcmlhbGl6ZXIiLCJuYW1lIiwiZ2V0UGF0aCIsImdldFRpdGxlIiwiZ2V0QmFzZU5hbWUiLCJnZXRVUkkiLCJyZWZzIiwic3VtbWFyeSIsInN0eWxlIiwiZGlzcGxheSIsInRyZWUiLCJsb2FkaW5nTWVzc2FnZSIsImVycm9yTWVzc2FnZSIsIm9yaWdpbmFsUGF0aCIsImFyY2hpdmUiLCJsaXN0IiwiZXJyb3IiLCJtZXNzYWdlIiwidGV4dENvbnRlbnQiLCJjcmVhdGVUcmVlRW50cmllcyIsInVwZGF0ZVN1bW1hcnkiLCJpbmRleCIsImVudHJ5IiwiaXNEaXJlY3RvcnkiLCJlbnRyeVZpZXciLCJEaXJlY3RvcnlWaWV3IiwicHVzaCIsIkZpbGVWaWV3Iiwic2VsZWN0RmlsZUFmdGVySW5kZXgiLCJhcHBlbmRDaGlsZCIsImZpbGVDb3VudCIsImZpbHRlciIsImZpbGVMYWJlbCIsImh1bWFuaXplIiwiaW50Q29tbWEiLCJkaXJlY3RvcnlDb3VudCIsImRpcmVjdG9yeUxhYmVsIiwiZmlsZVNpemUiLCJmcyIsInN0YXRTeW5jIiwic2l6ZSIsImUiLCJzZWxlY3RlZEZpbGUiLCJxdWVyeVNlbGVjdG9yIiwiZm9jdXMiLCJzZWxlY3RGaWxlQmVmb3JlSW5kZXgiLCJpIiwicHJldmlvdXNFbnRyeSIsInNlbGVjdCIsInNlbGVjdExhc3RGaWxlIiwibmV4dEVudHJ5Iiwic2VsZWN0Rmlyc3RGaWxlIl0sInNvdXJjZXMiOlsiYXJjaGl2ZS1lZGl0b3Itdmlldy5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKiogQGJhYmVsICovXG4vKiogQGpzeCBldGNoLmRvbSAqL1xuXG5pbXBvcnQgZnMgZnJvbSAnZnMnXG5pbXBvcnQgaHVtYW5pemUgZnJvbSAnaHVtYW5pemUtcGx1cydcbmltcG9ydCBhcmNoaXZlIGZyb20gJ2xzLWFyY2hpdmUnXG5pbXBvcnQge0NvbXBvc2l0ZURpc3Bvc2FibGUsIERpc3Bvc2FibGUsIEVtaXR0ZXIsIEZpbGV9IGZyb20gJ2F0b20nXG5pbXBvcnQgZXRjaCBmcm9tICdldGNoJ1xuXG5pbXBvcnQgRmlsZVZpZXcgZnJvbSAnLi9maWxlLXZpZXcnXG5pbXBvcnQgRGlyZWN0b3J5VmlldyBmcm9tICcuL2RpcmVjdG9yeS12aWV3J1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBBcmNoaXZlRWRpdG9yVmlldyB7XG4gIGNvbnN0cnVjdG9yIChhcmNoaXZlUGF0aCkge1xuICAgIHRoaXMuZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gICAgdGhpcy5lbWl0dGVyID0gbmV3IEVtaXR0ZXIoKVxuICAgIHRoaXMucGF0aCA9IGFyY2hpdmVQYXRoXG4gICAgdGhpcy5maWxlID0gbmV3IEZpbGUodGhpcy5wYXRoKVxuICAgIHRoaXMuZW50cmllcyA9IFtdXG4gICAgZXRjaC5pbml0aWFsaXplKHRoaXMpXG5cbiAgICB0aGlzLnJlZnJlc2goKVxuXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQodGhpcy5maWxlLm9uRGlkQ2hhbmdlKCgpID0+IHRoaXMucmVmcmVzaCgpKSlcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZCh0aGlzLmZpbGUub25EaWRSZW5hbWUoKCkgPT4gdGhpcy5yZWZyZXNoKCkpKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKHRoaXMuZmlsZS5vbkRpZERlbGV0ZSgoKSA9PiB0aGlzLmRlc3Ryb3koKSkpXG5cbiAgICBjb25zdCBmb2N1c0hhbmRsZXIgPSAoKSA9PiB0aGlzLmZvY3VzU2VsZWN0ZWRGaWxlKClcblxuICAgIHRoaXMuZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdmb2N1cycsIGZvY3VzSGFuZGxlcilcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChuZXcgRGlzcG9zYWJsZSgoKSA9PiB0aGlzLmVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignZm9jdXMnLCBmb2N1c0hhbmRsZXIpKSlcbiAgfVxuXG4gIHVwZGF0ZSAoKSB7fVxuXG4gIHJlbmRlciAoKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIDxkaXYgY2xhc3NOYW1lPSdhcmNoaXZlLWVkaXRvcicgdGFiSW5kZXg9Jy0xJz5cbiAgICAgICAgPGRpdiBjbGFzc05hbWU9J2FyY2hpdmUtY29udGFpbmVyJz5cbiAgICAgICAgICA8ZGl2IHJlZj0nbG9hZGluZ01lc3NhZ2UnIGNsYXNzTmFtZT0ncGFkZGVkIGljb24gaWNvbi1ob3VyZ2xhc3MgdGV4dC1pbmZvJz57YExvYWRpbmcgYXJjaGl2ZVxcdTIwMjZgfTwvZGl2PlxuICAgICAgICAgIDxkaXYgcmVmPSdlcnJvck1lc3NhZ2UnIGNsYXNzTmFtZT0ncGFkZGVkIGljb24gaWNvbi1hbGVydCB0ZXh0LWVycm9yJyAvPlxuICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSdpbnNldC1wYW5lbCc+XG4gICAgICAgICAgICA8ZGl2IHJlZj0nc3VtbWFyeScgY2xhc3NOYW1lPSdwYW5lbC1oZWFkaW5nJyAvPlxuICAgICAgICAgICAgPG9sIHJlZj0ndHJlZScgY2xhc3NOYW1lPSdhcmNoaXZlLXRyZWUgcGFkZGVkIGxpc3QtdHJlZSBoYXMtY29sbGFwc2FibGUtY2hpbGRyZW4nIC8+XG4gICAgICAgICAgPC9kaXY+XG4gICAgICAgIDwvZGl2PlxuICAgICAgPC9kaXY+XG4gICAgKVxuICB9XG5cbiAgY29weSAoKSB7XG4gICAgcmV0dXJuIG5ldyBBcmNoaXZlRWRpdG9yVmlldyh0aGlzLnBhdGgpXG4gIH1cblxuICBkZXN0cm95ICgpIHtcbiAgICB3aGlsZSAodGhpcy5lbnRyaWVzLmxlbmd0aCA+IDApIHtcbiAgICAgIHRoaXMuZW50cmllcy5wb3AoKS5kZXN0cm95KClcbiAgICB9XG4gICAgdGhpcy5kaXNwb3NhYmxlcy5kaXNwb3NlKClcbiAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnZGlkLWRlc3Ryb3knKVxuICAgIGV0Y2guZGVzdHJveSh0aGlzKVxuICB9XG5cbiAgb25EaWREZXN0cm95IChjYWxsYmFjaykge1xuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIub24oJ2RpZC1kZXN0cm95JywgY2FsbGJhY2spXG4gIH1cblxuICBvbkRpZENoYW5nZVRpdGxlIChjYWxsYmFjaykge1xuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIub24oJ2RpZC1jaGFuZ2UtdGl0bGUnLCBjYWxsYmFjaylcbiAgfVxuXG4gIHNlcmlhbGl6ZSAoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGRlc2VyaWFsaXplcjogdGhpcy5jb25zdHJ1Y3Rvci5uYW1lLFxuICAgICAgcGF0aDogdGhpcy5wYXRoXG4gICAgfVxuICB9XG5cbiAgZ2V0UGF0aCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuZmlsZS5nZXRQYXRoKClcbiAgfVxuXG4gIGdldFRpdGxlICgpIHtcbiAgICByZXR1cm4gdGhpcy5wYXRoID8gdGhpcy5maWxlLmdldEJhc2VOYW1lKCkgOiAndW50aXRsZWQnXG4gIH1cblxuICBnZXRVUkkgKCkge1xuICAgIHJldHVybiB0aGlzLnBhdGhcbiAgfVxuXG4gIHJlZnJlc2ggKCkge1xuICAgIHRoaXMucmVmcy5zdW1tYXJ5LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSdcbiAgICB0aGlzLnJlZnMudHJlZS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnXG4gICAgdGhpcy5yZWZzLmxvYWRpbmdNZXNzYWdlLnN0eWxlLmRpc3BsYXkgPSAnJ1xuICAgIHRoaXMucmVmcy5lcnJvck1lc3NhZ2Uuc3R5bGUuZGlzcGxheSA9ICdub25lJ1xuXG4gICAgaWYgKHRoaXMucGF0aCAhPT0gdGhpcy5nZXRQYXRoKCkpIHtcbiAgICAgIHRoaXMucGF0aCA9IHRoaXMuZ2V0UGF0aCgpXG4gICAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnZGlkLWNoYW5nZS10aXRsZScpXG4gICAgfVxuXG4gICAgY29uc3Qgb3JpZ2luYWxQYXRoID0gdGhpcy5wYXRoXG4gICAgYXJjaGl2ZS5saXN0KHRoaXMucGF0aCwge3RyZWU6IHRydWV9LCAoZXJyb3IsIGVudHJpZXMpID0+IHtcbiAgICAgIGlmIChvcmlnaW5hbFBhdGggIT09IHRoaXMucGF0aCkge1xuICAgICAgICByZXR1cm5cbiAgICAgIH1cblxuICAgICAgaWYgKGVycm9yICE9IG51bGwpIHtcbiAgICAgICAgbGV0IG1lc3NhZ2UgPSAnUmVhZGluZyB0aGUgYXJjaGl2ZSBmaWxlIGZhaWxlZCdcbiAgICAgICAgaWYgKGVycm9yLm1lc3NhZ2UpIHtcbiAgICAgICAgICBtZXNzYWdlICs9IGA6ICR7ZXJyb3IubWVzc2FnZX1gXG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5yZWZzLmVycm9yTWVzc2FnZS5zdHlsZS5kaXNwbGF5ID0gJydcbiAgICAgICAgdGhpcy5yZWZzLmVycm9yTWVzc2FnZS50ZXh0Q29udGVudCA9IG1lc3NhZ2VcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuY3JlYXRlVHJlZUVudHJpZXMoZW50cmllcylcbiAgICAgICAgdGhpcy51cGRhdGVTdW1tYXJ5KClcbiAgICAgIH1cblxuICAgICAgLy8gV2UgaGlkZSB0aGUgbG9hZGluZyBtZXNzYWdlIF9hZnRlcl8gY3JlYXRpbmcgdGhlIGFyY2hpdmUgdHJlZVxuICAgICAgLy8gdG8gYXZvaWQgZm9yY2VkIHJlZmxvd3MuXG4gICAgICB0aGlzLnJlZnMubG9hZGluZ01lc3NhZ2Uuc3R5bGUuZGlzcGxheSA9ICdub25lJ1xuICAgIH0pXG4gIH1cblxuICBjcmVhdGVUcmVlRW50cmllcyAoZW50cmllcykge1xuICAgIHdoaWxlICh0aGlzLmVudHJpZXMubGVuZ3RoID4gMCkge1xuICAgICAgdGhpcy5lbnRyaWVzLnBvcCgpLmRlc3Ryb3koKVxuICAgIH1cblxuICAgIGxldCBpbmRleCA9IDBcbiAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIGVudHJpZXMpIHtcbiAgICAgIGlmIChlbnRyeS5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgIGNvbnN0IGVudHJ5VmlldyA9IG5ldyBEaXJlY3RvcnlWaWV3KHRoaXMsIGluZGV4LCB0aGlzLnBhdGgsIGVudHJ5KVxuICAgICAgICB0aGlzLmVudHJpZXMucHVzaChlbnRyeVZpZXcpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBlbnRyeVZpZXcgPSBuZXcgRmlsZVZpZXcodGhpcywgaW5kZXgsIHRoaXMucGF0aCwgZW50cnkpXG4gICAgICAgIHRoaXMuZW50cmllcy5wdXNoKGVudHJ5VmlldylcbiAgICAgIH1cbiAgICAgIGluZGV4KytcbiAgICB9XG5cbiAgICB0aGlzLnNlbGVjdEZpbGVBZnRlckluZGV4KC0xKVxuXG4gICAgLy8gV2FpdCB1bnRpbCBzZWxlY3RpbmcgKGZvY3VzaW5nKSB0aGUgZmlyc3QgZmlsZSBiZWZvcmUgYXBwZW5kaW5nIHRoZSBlbnRyaWVzXG4gICAgLy8gdG8gYXZvaWQgYSBkb3VibGUtZm9yY2VkIHJlZmxvdyB3aGVuIGZvY3VzaW5nLlxuICAgIGZvciAoY29uc3QgZW50cnkgb2YgdGhpcy5lbnRyaWVzKSB7XG4gICAgICB0aGlzLnJlZnMudHJlZS5hcHBlbmRDaGlsZChlbnRyeS5lbGVtZW50KVxuICAgIH1cblxuICAgIHRoaXMucmVmcy50cmVlLnN0eWxlLmRpc3BsYXkgPSAnJ1xuICB9XG5cbiAgdXBkYXRlU3VtbWFyeSAoKSB7XG4gICAgY29uc3QgZmlsZUNvdW50ID0gdGhpcy5lbnRyaWVzLmZpbHRlcigoZW50cnkpID0+IGVudHJ5IGluc3RhbmNlb2YgRmlsZVZpZXcpLmxlbmd0aFxuICAgIGNvbnN0IGZpbGVMYWJlbCA9IGZpbGVDb3VudCA9PT0gMSA/ICcxIGZpbGUnIDogYCR7aHVtYW5pemUuaW50Q29tbWEoZmlsZUNvdW50KX0gZmlsZXNgXG5cbiAgICBjb25zdCBkaXJlY3RvcnlDb3VudCA9IHRoaXMuZW50cmllcy5maWx0ZXIoKGVudHJ5KSA9PiBlbnRyeSBpbnN0YW5jZW9mIERpcmVjdG9yeVZpZXcpLmxlbmd0aFxuICAgIGNvbnN0IGRpcmVjdG9yeUxhYmVsID0gZGlyZWN0b3J5Q291bnQgPT09IDEgPyAnMSBmb2xkZXInIDogYCR7aHVtYW5pemUuaW50Q29tbWEoZGlyZWN0b3J5Q291bnQpfSBmb2xkZXJzYFxuXG4gICAgdGhpcy5yZWZzLnN1bW1hcnkuc3R5bGUuZGlzcGxheSA9ICcnXG4gICAgbGV0IGZpbGVTaXplXG4gICAgdHJ5IHtcbiAgICAgIGZpbGVTaXplID0gZnMuc3RhdFN5bmModGhpcy5wYXRoKT8uc2l6ZTtcbiAgICB9IGNhdGNoIChlKSB7fVxuICAgIGlmIChmaWxlU2l6ZSA9PSBudWxsKSBmaWxlU2l6ZSA9IC0xXG4gICAgdGhpcy5yZWZzLnN1bW1hcnkudGV4dENvbnRlbnQgPSBgJHtodW1hbml6ZS5maWxlU2l6ZShmaWxlU2l6ZSl9IHdpdGggJHtmaWxlTGFiZWx9IGFuZCAke2RpcmVjdG9yeUxhYmVsfWBcbiAgfVxuXG4gIGZvY3VzU2VsZWN0ZWRGaWxlICgpIHtcbiAgICBjb25zdCBzZWxlY3RlZEZpbGUgPSB0aGlzLnJlZnMudHJlZS5xdWVyeVNlbGVjdG9yKCcuc2VsZWN0ZWQnKVxuICAgIGlmIChzZWxlY3RlZEZpbGUpIHtcbiAgICAgIHNlbGVjdGVkRmlsZS5mb2N1cygpXG4gICAgfVxuICB9XG5cbiAgc2VsZWN0RmlsZUJlZm9yZUluZGV4IChpbmRleCkge1xuICAgIGZvciAobGV0IGkgPSBpbmRleCAtIDE7IGkgPj0gMDsgaS0tKSB7XG4gICAgICBjb25zdCBwcmV2aW91c0VudHJ5ID0gdGhpcy5lbnRyaWVzW2ldXG4gICAgICBpZiAocHJldmlvdXNFbnRyeSBpbnN0YW5jZW9mIEZpbGVWaWV3KSB7XG4gICAgICAgIHByZXZpb3VzRW50cnkuc2VsZWN0KClcbiAgICAgICAgYnJlYWtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChwcmV2aW91c0VudHJ5LnNlbGVjdExhc3RGaWxlKCkpIHtcbiAgICAgICAgICBicmVha1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgc2VsZWN0RmlsZUFmdGVySW5kZXggKGluZGV4KSB7XG4gICAgZm9yIChsZXQgaSA9IGluZGV4ICsgMTsgaSA8IHRoaXMuZW50cmllcy5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgbmV4dEVudHJ5ID0gdGhpcy5lbnRyaWVzW2ldXG4gICAgICBpZiAobmV4dEVudHJ5IGluc3RhbmNlb2YgRmlsZVZpZXcpIHtcbiAgICAgICAgbmV4dEVudHJ5LnNlbGVjdCgpXG4gICAgICAgIGJyZWFrXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAobmV4dEVudHJ5LnNlbGVjdEZpcnN0RmlsZSgpKSB7XG4gICAgICAgICAgYnJlYWtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGZvY3VzICgpIHtcbiAgICB0aGlzLmZvY3VzU2VsZWN0ZWRGaWxlKClcbiAgfVxufVxuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFHQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBRUE7QUFDQTtBQUE0QztBQVY1QztBQUNBOztBQVdlLE1BQU1BLGlCQUFpQixDQUFDO0VBQ3JDQyxXQUFXLENBQUVDLFdBQVcsRUFBRTtJQUN4QixJQUFJLENBQUNDLFdBQVcsR0FBRyxJQUFJQyx5QkFBbUIsRUFBRTtJQUM1QyxJQUFJLENBQUNDLE9BQU8sR0FBRyxJQUFJQyxh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